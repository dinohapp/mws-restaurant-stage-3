!function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);class n{constructor(e="keyval-store",t="keyval"){this.storeName=t,this._dbp=new Promise((r,n)=>{const s=indexedDB.open(e,1);s.onerror=(()=>n(s.error)),s.onsuccess=(()=>r(s.result)),s.onupgradeneeded=(()=>{s.result.createObjectStore(t)})})}_withIDBStore(e,t){return this._dbp.then(r=>new Promise((n,s)=>{const o=r.transaction(this.storeName,e);o.oncomplete=(()=>n()),o.onabort=o.onerror=(()=>s(o.error)),t(o.objectStore(this.storeName))}))}}let s;function o(){return s||(s=new n),s}function i(e,t=o()){let r;return t._withIDBStore("readonly",t=>{r=t.get(e)}).then(()=>r.result)}function a(e,t,r=o()){return r._withIDBStore("readwrite",r=>{r.put(t,e)})}function u(e=o()){const t=[];return e._withIDBStore("readonly",e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}}).then(()=>t)}let l=new n("restaurantsDB","restaurants"),c=new n("reviewsDB","reviews");class h{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static get DATABASE_REVIEWS_URL(){return"http://localhost:1337/reviews"}static fetchRestaurants(){return u(l).then(e=>0==e.length?h.fetchRest().then(e=>Promise.resolve(e)):i("restaurants",l).then(e=>Promise.resolve(e)))}static fetchRest(){return fetch(h.DATABASE_URL).then(e=>e.json()).then(e=>(a("restaurants",e,l),Promise.resolve(e)))}static fetchReviews(e){return u(c).then(t=>0==t.length?h.fetchRev(e).then(e=>Promise.resolve(e)):h.getDBRev(e).then(e=>Promise.resolve(e)))}static getDBRev(e){return i("reviews",c).then(t=>0!==t.filter(t=>t.restaurant_id===e).length?Promise.resolve(t):h.fetchRev(e).then(e=>Promise.resolve(e)))}static fetchRev(e){return fetch(`${h.DATABASE_REVIEWS_URL}/?restaurant_id=${e}`).then(e=>e.json()).then(e=>(a("reviews",e,c),a("offlineReviews",[],c),Promise.resolve(e)))}static toggleFavorite(e,t){fetch(`http://localhost:1337/restaurants/${e}/?is_favorite=${t}`,{method:"PUT"}).then(()=>i("restaurants",l).then(r=>{a("restaurants",r.map(r=>r.id===e?{...r,is_favorite:t}:r),l)}))}static fetchRestaurantById(e){return h.fetchRestaurants().then(t=>{const r=t.find(t=>t.id==e);return Promise.resolve(r)})}static fetchRestaurantByCuisine(e){return h.fetchRestaurants().then(e=>{const t=e.filter(e=>e.cuisine_type==t);return Promise.resolve(t)})}static fetchRestaurantByNeighborhood(e){return h.fetchRestaurants().then(e=>{const t=e.filter(e=>e.neighborhood==t);return Promise.resolve(t)})}static fetchRestaurantByCuisineAndNeighborhood(e,t){return h.fetchRestaurants().then(r=>{let n=r;return"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),Promise.resolve(n)})}static fetchNeighborhoods(){return h.fetchRestaurants().then(e=>{const t=e.map((t,r)=>e[r].neighborhood),r=t.filter((e,r)=>t.indexOf(e)==r);return Promise.resolve(r)})}static fetchCuisines(){return h.fetchRestaurants().then(e=>{const t=e.map((t,r)=>e[r].cuisine_type),r=t.filter((e,r)=>t.indexOf(e)==r);return Promise.resolve(r)})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph}.webp`}static imageAltForRestaurant(e){return`${e.photograph_description}`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:h.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static pushReviewsWhenOnline(){return i("offlineReviews",c).then(e=>{e.forEach(e=>{h.pushReviewsToDB(e),h.pushReviewsToServer(e)})})}static storeOfflineReviews(e){return i("offlineReviews",c).then(t=>(t.push(e),console.log("reviews stored offline: "+t),a("offlineReviews",t,c)))}static processNewReview(e){let t=JSON.parse(e),r=0;return i("offlineReviews",c).then(e=>r=e.length),console.log(r),u(c).then(e=>{t.id=e.length+r+1,0==navigator.onLine&&0!==r?(console.log("pushing reviews offline, array:"),h.storeOfflineReviews(t)):(console.log("pushing review to db and to server"),h.pushReviewsToDB(t),h.pushReviewsToServer(t))})}static pushReviewsToDB(e){return console.log(`pushing revew ${e.id} to db`),i("reviews",c).then(t=>(t.push(e),a("reviews",t,c)))}static pushReviewsToServer(e){fetch(h.DATABASE_REVIEWS_URL,{method:"POST",body:JSON.stringify(e)})}}window.DBHelper=h}]);